<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHG Emissions Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #e0f7e9 0%, #dbeafe 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.5rem; color: #065f46; margin-bottom: 10px; }
        .header p { color: #6b7280; font-size: 1.1rem; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 30px; }
        .upload-area { border: 3px dashed #d1d5db; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 20px; }
        .upload-area:hover { border-color: #10b981; background: #f0fdf4; }
        .upload-area.dragover { border-color: #10b981; background: #d1fae5; }
        .upload-icon { font-size: 3rem; color: #9ca3af; margin-bottom: 10px; }
        .button { background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background 0.3s; margin: 5px; }
        .button:hover { background: #059669; }
        .button:disabled { background: #d1d5db; cursor: not-allowed; }
        .button-secondary { background: #3b82f6; }
        .button-secondary:hover { background: #2563eb; }
        .button-export { background: #8b5cf6; }
        .button-export:hover { background: #7c3aed; }
        .error { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .success { background: #d1fae5; border: 1px solid #6ee7b7; color: #065f46; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #10b981; }
        .stat-card.blue { border-left-color: #3b82f6; }
        .stat-card.orange { border-left-color: #f59e0b; }
        .stat-card.purple { border-left-color: #8b5cf6; }
        .stat-card.red { border-left-color: #ef4444; }
        .stat-card.indigo { border-left-color: #6366f1; }
        .stat-label { font-size: 0.875rem; color: #6b7280; margin-bottom: 8px; }
        .stat-value { font-size: 1.75rem; font-weight: bold; color: #10b981; }
        .stat-card.blue .stat-value { color: #3b82f6; }
        .stat-card.orange .stat-value { color: #f59e0b; }
        .stat-card.purple .stat-value { color: #8b5cf6; }
        .stat-card.red .stat-value { color: #ef4444; }
        .stat-card.indigo .stat-value { color: #6366f1; }
        .stat-unit { font-size: 0.75rem; color: #9ca3af; margin-top: 4px; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .chart-container h3 { margin-bottom: 15px; color: #374151; font-size: 1.1rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; color: #374151; font-size: 0.875rem; }
        tr:hover { background: #f9fafb; }
        .fuel-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; background: #dbeafe; color: #1e40af; }
        .location-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; background: #e0e7ff; color: #3730a3; }
        .hidden { display: none; }
        .section-title { font-size: 1.5rem; color: #374151; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; }
        .highlight-box { background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b; }
        .highlight-box h4 { color: #92400e; margin-bottom: 10px; }
        .highlight-box p { color: #78350f; font-size: 1.1rem; font-weight: 600; }
        .metric-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
        .metric-label { color: #6b7280; font-weight: 500; }
        .metric-value { color: #374151; font-weight: 600; }
        .export-buttons { text-align: center; margin-top: 20px; }
        .action-box { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 25px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #10b981; }
        .action-box h4 { color: #065f46; margin-bottom: 15px; font-size: 1.2rem; }
        .action-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 3px solid #f59e0b; }
        .action-item strong { color: #92400e; }
        .assumptions { background: #fffbeb; border: 1px solid #fcd34d; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .assumptions h3 { color: #92400e; margin-bottom: 15px; }
        .assumptions ul { margin-left: 20px; color: #78350f; }
        .assumptions li { margin-bottom: 8px; }
        .disclaimer { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin-top: 15px; font-size: 0.875rem; color: #78350f; }
        @media print { body { background: white; padding: 0; } .button, .upload-area, .export-buttons { display: none !important; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± GHG Emissions Calculator</h1>
            <p>Comprehensive Employee Commuting Analysis (Scope 3) - India Optimized</p>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 20px;">Upload Your Data</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <p style="font-size: 1.1rem; margin-bottom: 10px;">Click to upload or drag & drop</p>
                <p style="color: #6b7280; font-size: 0.875rem;">CSV or Excel files only</p>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
            </div>
            <div style="text-align: center;">
                <button class="button button-secondary" onclick="downloadTemplate()">üì• Download Template</button>
                <button class="button" id="calculateBtn" onclick="calculateEmissions()" disabled>Calculate Emissions</button>
            </div>
            <div id="message"></div>
        </div>

        <div id="results" class="hidden">
            <div class="export-buttons">
                <button class="button button-export" onclick="exportToPDF()">üìÑ Export to PDF</button>
                <button class="button button-export" onclick="exportToExcel()">üìä Export Data to Excel</button>
            </div>

            <div class="card">
                <h2 class="section-title">üìä Executive Summary</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Total Emissions</div><div class="stat-value" id="totalEmissions">0</div><div class="stat-unit">kg CO2e</div></div>
                    <div class="stat-card blue"><div class="stat-label">Total Vehicles</div><div class="stat-value" id="totalVehicles">0</div><div class="stat-unit">vehicles</div></div>
                    <div class="stat-card orange"><div class="stat-label">Total Distance</div><div class="stat-value" id="totalDistance">0</div><div class="stat-unit">km</div></div>
                    <div class="stat-card purple"><div class="stat-label">Total Fuel Cost</div><div class="stat-value" id="totalFuelCost">‚Çπ0</div><div class="stat-unit">estimated</div></div>
                    <div class="stat-card red"><div class="stat-label">Avg per Vehicle</div><div class="stat-value" id="avgEmissions">0</div><div class="stat-unit">kg CO2e</div></div>
                    <div class="stat-card indigo"><div class="stat-label">Avg per Employee</div><div class="stat-value" id="avgPerEmployee">0</div><div class="stat-unit">kg CO2e</div></div>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">üí° Key Insights & Recommended Actions</h2>
                <div id="keyInsights"></div>
                <div id="actionItems"></div>
            </div>

            <div class="card" id="locationSection">
                <h2 class="section-title">üìç Location & Campus Analysis</h2>
                <div class="charts-grid">
                    <div class="chart-container"><h3>Emissions by Location</h3><canvas id="locationChart"></canvas></div>
                    <div class="chart-container"><h3>Vehicles by Location</h3><canvas id="locationVehiclesChart"></canvas></div>
                </div>
                <table id="locationTable"><thead><tr><th>Location</th><th>Vehicles</th><th>Distance (km)</th><th>Emissions (kg CO2e)</th><th>Cost (‚Çπ)</th></tr></thead><tbody></tbody></table>
            </div>

            <div class="card" id="timeSection">
                <h2 class="section-title">üìÖ Daily & Time Analysis</h2>
                <div class="charts-grid">
                    <div class="chart-container"><h3>Emissions Over Time</h3><canvas id="timeChart"></canvas></div>
                    <div class="chart-container"><h3>Peak Days</h3><canvas id="peakDaysChart"></canvas></div>
                </div>
                <div id="peakDayInfo"></div>
            </div>

            <div class="card">
                <h2 class="section-title">‚õΩ Fuel Type Analysis</h2>
                <div class="charts-grid">
                    <div class="chart-container"><h3>Emissions by Fuel Type</h3><canvas id="barChart"></canvas></div>
                    <div class="chart-container"><h3>Emissions Share</h3><canvas id="pieChart"></canvas></div>
                </div>
                <table id="fuelTypeTable"><thead><tr><th>Fuel Type</th><th>Vehicles</th><th>Distance (km)</th><th>Emissions (kg CO2e)</th><th>Cost (‚Çπ)</th><th>Avg/Vehicle</th></tr></thead><tbody></tbody></table>
            </div>

            <div class="card">
                <h2 class="section-title">üöó Per Vehicle Impact</h2>
                <div style="overflow-x: auto;"><table id="perVehicleTable"><thead><tr><th>Vehicle ID</th><th>Type</th><th>Fuel</th><th>Location</th><th>Distance</th><th>Emissions</th><th>Cost</th><th>CO2e/km</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div class="card">
                <h2 class="section-title">üî¥ Top 10 Emitters</h2>
                <table id="topEmittersTable"><thead><tr><th>#</th><th>Vehicle ID</th><th>Type</th><th>Fuel</th><th>Location</th><th>Distance</th><th>Emissions</th><th>Cost</th></tr></thead><tbody></tbody></table>
            </div>

            <div class="card" id="employeeSection">
                <h2 class="section-title">üë• Employee Impact</h2>
                <div id="employeeMetrics"></div>
            </div>
        </div>

        <div class="card assumptions">
            <h3>üìä Assumptions</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div><strong>Emission Factors:</strong><ul><li>Diesel: 2.68 kg CO2e/L</li><li>Petrol: 2.31 kg CO2e/L</li><li>CNG: 2.75 kg CO2e/kg</li><li>Electric: 0.82 kg CO2e/kWh</li></ul></div>
                <div><strong>Fuel Efficiency:</strong><ul><li>Sedan (Diesel): 15 km/L</li><li>SUV (Diesel): 12 km/L</li><li>Hatchback: 16 km/L</li><li>CNG: 18 km/kg</li><li>Electric: 5 km/kWh</li></ul></div>
                <div><strong>Fuel Prices:</strong><ul><li>Diesel: ‚Çπ95/L</li><li>Petrol: ‚Çπ105/L</li><li>CNG: ‚Çπ75/kg</li><li>Electric: ‚Çπ8/kWh</li></ul></div>
            </div>
            <div class="disclaimer"><strong>‚ö†Ô∏è Disclaimer:</strong> Indicative estimates only. For audit-grade reporting, consult certified professionals.</div>
        </div>
    </div>

    <script>
        const EMISSION_FACTORS = { diesel: 2.68, petrol: 2.31, cng: 2.75, electric: 0.82 };
        const FUEL_PRICES = { diesel: 95, petrol: 105, cng: 75, electric: 8 };
        const FUEL_EFFICIENCY = {
            'sedan-diesel': 15, 'sedan-petrol': 14, 'sedan-cng': 18, 'sedan-electric': 5,
            'suv-diesel': 12, 'suv-petrol': 10, 'suv-cng': 15, 'suv-electric': 4,
            'hatchback-diesel': 15, 'hatchback-petrol': 16, 'hatchback-cng': 18, 'hatchback-electric': 6
        };

        let currentData = null, processedData = null, analytics = null, charts = {};
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const calculateBtn = document.getElementById('calculateBtn');
        const messageDiv = document.getElementById('message');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); });

        function handleFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (!['csv', 'xlsx', 'xls'].includes(ext)) { showMessage('Please upload CSV/Excel', 'error'); return; }
            showMessage(`File "${file.name}" loaded!`, 'success');
            calculateBtn.disabled = false;
            if (ext === 'csv') {
                Papa.parse(file, { complete: (r) => currentData = r.data, header: true, skipEmptyLines: true });
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    currentData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function getFuelEfficiency(vType, fType) {
            return FUEL_EFFICIENCY[`${vType.toLowerCase()}-${fType.toLowerCase()}`] || 12;
        }

        function calculateEmissions() {
            if (!currentData?.length) { showMessage('No data', 'error'); return; }
            try {
                currentData = currentData.map(row => {
                    const n = {};
                    Object.keys(row).forEach(k => n[k.toLowerCase().trim()] = row[k]);
                    return n;
                });

                processedData = currentData.filter(r => r.vehicle_id && r.distance_km && r.fuel_type).map(r => {
                    const dist = parseFloat(r.distance_km);
                    const vType = r.vehicle_type || 'sedan';
                    const fType = r.fuel_type;
                    const eff = getFuelEfficiency(vType, fType);
                    const fuel = dist / eff;
                    const emissions = fuel * (EMISSION_FACTORS[fType.toLowerCase()] || 2.5);
                    const cost = fuel * (FUEL_PRICES[fType.toLowerCase()] || 90);
                    return {
                        vehicle_id: r.vehicle_id, vehicle_type: vType, fuel_type: fType,
                        distance_km: dist, emissions_kg: emissions, fuel_cost: cost,
                        co2_per_km: emissions / dist,
                        location: r.location || r.campus || r.office || r.city || 'Not Specified',
                        date: r.date || r.trip_date || r.day || null,
                        employee_id: r.employee_id || r.emp_id || null,
                        employees_count: parseFloat(r.employees || r.passengers || 1)
                    };
                });

                if (!processedData.length) { showMessage('No valid data', 'error'); return; }

                analytics = calculateAnalytics(processedData);
                displayResults(analytics, processedData);
                showMessage('', '');
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function calculateAnalytics(data) {
            const total = (arr, key) => arr.reduce((s, r) => s + r[key], 0);
            const totalEmissions = total(data, 'emissions_kg');
            const totalDistance = total(data, 'distance_km');
            const totalFuelCost = total(data, 'fuel_cost');
            const totalEmployees = total(data, 'employees_count');

            const groupBy = (key) => {
                const g = {};
                data.forEach(r => {
                    const k = key === 'fuel_type' ? r[key].toLowerCase() : r[key];
                    if (!g[k]) g[k] = { emissions: 0, distance: 0, cost: 0, count: 0 };
                    g[k].emissions += r.emissions_kg;
                    g[k].distance += r.distance_km;
                    g[k].cost += r.fuel_cost;
                    g[k].count++;
                });
                return g;
            };

            const byFuelType = groupBy('fuel_type');
            const byLocation = groupBy('location');
            const byDate = {};
            data.forEach(r => {
                if (r.date) {
                    if (!byDate[r.date]) byDate[r.date] = { emissions: 0, distance: 0, count: 0 };
                    byDate[r.date].emissions += r.emissions_kg;
                    byDate[r.date].distance += r.distance_km;
                    byDate[r.date].count++;
                }
            });

            let peakDay = { date: 'N/A', emissions: 0 };
            Object.keys(byDate).forEach(d => {
                if (byDate[d].emissions > peakDay.emissions) peakDay = { date: d, emissions: byDate[d].emissions };
            });

            return {
                totalEmissions, totalVehicles: data.length, totalDistance, totalFuelCost, totalEmployees,
                avgEmissions: totalEmissions / data.length,
                avgPerEmployee: totalEmployees > 0 ? totalEmissions / totalEmployees : 0,
                byFuelType, byLocation, byDate, peakDay,
                topEmitters: [...data].sort((a, b) => b.emissions_kg - a.emissions_kg).slice(0, 10)
            };
        }

        function displayResults(a, data) {
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('totalEmissions').textContent = Math.round(a.totalEmissions).toLocaleString();
            document.getElementById('totalVehicles').textContent = a.totalVehicles;
            document.getElementById('totalDistance').textContent = Math.round(a.totalDistance).toLocaleString();
            document.getElementById('totalFuelCost').textContent = '‚Çπ' + Math.round(a.totalFuelCost).toLocaleString();
            document.getElementById('avgEmissions').textContent = Math.round(a.avgEmissions).toLocaleString();
            document.getElementById('avgPerEmployee').textContent = Math.round(a.avgPerEmployee).toLocaleString();

            displayKeyInsights(a);
            displayActionItems(a, data);
            if (Object.keys(a.byLocation).length > 1) displayLocationAnalysis(a.byLocation); else document.getElementById('locationSection').style.display = 'none';
            if (Object.keys(a.byDate).length > 0) displayTimeAnalysis(a.byDate, a.peakDay); else document.getElementById('timeSection').style.display = 'none';
            displayFuelTypeAnalysis(a.byFuelType);
            displayPerVehicleTable(data);
            displayTopEmitters(a.topEmitters);
            displayEmployeeMetrics(a, data);
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function displayKeyInsights(a) {
            const mostFuel = Object.keys(a.byFuelType).reduce((x, y) => a.byFuelType[x].count > a.byFuelType[y].count ? x : y);
            const mostLoc = Object.keys(a.byLocation).reduce((x, y) => a.byLocation[x].emissions > a.byLocation[y].emissions ? x : y);
            const trees = Math.round(a.totalEmissions / 411);
            document.getElementById('keyInsights').innerHTML = `
                <div class="highlight-box"><h4>üèÜ Most Common Fuel</h4><p>${mostFuel.toUpperCase()} - ${a.byFuelType[mostFuel].count} vehicles (${Math.round(a.byFuelType[mostFuel].count / a.totalVehicles * 100)}%)</p></div>
                <div class="highlight-box" style="background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);"><h4>üìç Highest Emitting Location</h4><p>${mostLoc} - ${Math.round(a.byLocation[mostLoc].emissions).toLocaleString()} kg CO2e</p></div>
                <div class="metric-row"><span class="metric-label">Avg Fuel Cost/Vehicle:</span><span class="metric-value">‚Çπ${Math.round(a.totalFuelCost / a.totalVehicles).toLocaleString()}</span></div>
                <div class="metric-row"><span class="metric-label">CO2e = Trees Needed (1 yr):</span><span class="metric-value">${trees} trees</span></div>
            `;
        }

        function displayActionItems(a, data) {
            const dieselPct = a.byFuelType.diesel ? Math.round(a.byFuelType.diesel.count / a.totalVehicles * 100) : 0;
            const electricPct = a.byFuelType.electric ? Math.round(a.byFuelType.electric.count / a.totalVehicles * 100) : 0;
            let actions = '<div class="action-box"><h4>üéØ Recommended Actions</h4>';
            if (dieselPct > 50) actions += '<div class="action-item"><strong>High Diesel Usage:</strong> Consider transitioning to CNG or electric vehicles to reduce emissions by up to 70%</div>';
            if (electricPct < 10) actions += '<div class="action-item"><strong>Low EV Adoption:</strong> Implement EV fleet program - potential savings of ‚Çπ' + Math.round(a.totalFuelCost * 0.4).toLocaleString() + '</div>';
            if (a.peakDay.date !== 'N/A') actions += '<div class="action-item"><strong>Peak Day Optimization:</strong> On ' + a.peakDay.date + ', emissions peaked. Consider carpooling or route optimization</div>';
            const highEmitters = data.filter(v => v.emissions_kg > a.avgEmissions * 1.5).length;
            if (highEmitters > 0) actions += '<div class="action-item"><strong>High Emitters:</strong> ' + highEmitters + ' vehicles emit 50% above average. Review routes and vehicle efficiency</div>';
            actions += '</div>';
            document.getElementById('actionItems').innerHTML = actions;
        }

        function displayLocationAnalysis(byLoc) {
            const locs = Object.keys(byLoc);
            const emis = locs.map(l => Math.round(byLoc[l].emissions));
            const vehs = locs.map(l => byLoc[l].count);
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899'];
            
            if (charts.location) charts.location.destroy();
            if (charts.locationVehicles) charts.locationVehicles.destroy();
            
            charts.location = new Chart(document.getElementById('locationChart').getContext('2d'), {
                type: 'bar', data: { labels: locs, datasets: [{ label: 'Emissions (kg CO2e)', data: emis, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } }
            });
            
            charts.locationVehicles = new Chart(document.getElementById('locationVehiclesChart').getContext('2d'), {
                type: 'doughnut', data: { labels: locs, datasets: [{ data: vehs, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: true }
            });
            
            const tbody = document.querySelector('#locationTable tbody');
            tbody.innerHTML = '';
            locs.forEach(l => {
                const d = byLoc[l];
                tbody.insertRow().innerHTML = `<td><span class="location-badge">${l}</span></td><td>${d.count}</td><td>${Math.round(d.distance).toLocaleString()}</td><td style="font-weight: bold; color: #10b981;">${Math.round(d.emissions).toLocaleString()}</td><td>‚Çπ${Math.round(d.cost).toLocaleString()}</td>`;
            });
        }

        function displayTimeAnalysis(byDate, peakDay) {
            const dates = Object.keys(byDate).sort();
            const emis = dates.map(d => Math.round(byDate[d].emissions));
            if (charts.time) charts.time.destroy();
            if (charts.peakDays) charts.peakDays.destroy();
            
            charts.time = new Chart(document.getElementById('timeChart').getContext('2d'), {
                type: 'line', data: { labels: dates, datasets: [{ label: 'Daily Emissions', data: emis, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4, fill: true }] },
                options: { responsive: true, maintainAspectRatio: true }
            });
            
            const topDays = dates.map(d => ({ date: d, emissions: byDate[d].emissions })).sort((a, b) => b.emissions - a.emissions).slice(0, 5);
            charts.peakDays = new Chart(document.getElementById('peakDaysChart').getContext('2d'), {
                type: 'bar', data: { labels: topDays.map(d => d.date), datasets: [{ label: 'Top 5 Days', data: topDays.map(d => Math.round(d.emissions)), backgroundColor: ['#ef4444', '#f59e0b', '#eab308', '#84cc16', '#22c55e'] }] },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } }
            });
            
            document.getElementById('peakDayInfo').innerHTML = `<div class="highlight-box" style="background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);"><h4>üî• Peak Day</h4><p>${peakDay.date} - ${Math.round(peakDay.emissions).toLocaleString()} kg CO2e</p></div>`;
        }

        function displayFuelTypeAnalysis(byFuel) {
            const fuels = Object.keys(byFuel);
            const emis = fuels.map(f => Math.round(byFuel[f].emissions));
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
            if (charts.bar) charts.bar.destroy();
            if (charts.pie) charts.pie.destroy();
            
            charts.bar = new Chart(document.getElementById('barChart').getContext('2d'), {
                type: 'bar', data: { labels: fuels, datasets: [{ label: 'Emissions', data: emis, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } }
            });
            
            charts.pie = new Chart(document.getElementById('pieChart').getContext('2d'), {
                type: 'pie', data: { labels: fuels, datasets: [{ data: emis, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: true }
            });
            
            const tbody = document.querySelector('#fuelTypeTable tbody');
            tbody.innerHTML = '';
            fuels.forEach(f => {
                const d = byFuel[f];
                tbody.insertRow().innerHTML = `<td><span class="fuel-badge">${f.toUpperCase()}</span></td><td>${d.count}</td><td>${Math.round(d.distance).toLocaleString()}</td><td style="font-weight: bold; color: #10b981;">${Math.round(d.emissions).toLocaleString()}</td><td>‚Çπ${Math.round(d.cost).toLocaleString()}</td><td>${Math.round(d.emissions / d.count).toLocaleString()} kg</td>`;
            });
        }

        function displayPerVehicleTable(data) {
            const tbody = document.querySelector('#perVehicleTable tbody');
            tbody.innerHTML = '';
            data.forEach(v => {
                tbody.insertRow().innerHTML = `<td>${v.vehicle_id}</td><td>${v.vehicle_type}</td><td><span class="fuel-badge">${v.fuel_type}</span></td><td><span class="location-badge">${v.location}</span></td><td>${Math.round(v.distance_km).toLocaleString()}</td><td style="font-weight: bold; color: #10b981;">${Math.round(v.emissions_kg).toLocaleString()}</td><td>‚Çπ${Math.round(v.fuel_cost).toLocaleString()}</td><td>${v.co2_per_km.toFixed(2)}</td>`;
            });
        }

        function displayTopEmitters(topEmitters) {
            const tbody = document.querySelector('#topEmittersTable tbody');
            tbody.innerHTML = '';
            topEmitters.forEach((v, i) => {
                tbody.insertRow().innerHTML = `<td style="font-weight: bold;">#${i + 1}</td><td>${v.vehicle_id}</td><td>${v.vehicle_type}</td><td><span class="fuel-badge">${v.fuel_type}</span></td><td><span class="location-badge">${v.location}</span></td><td>${Math.round(v.distance_km).toLocaleString()}</td><td style="font-weight: bold; color: #ef4444;">${Math.round(v.emissions_kg).toLocaleString()}</td><td>‚Çπ${Math.round(v.fuel_cost).toLocaleString()}</td>`;
            });
        }

        function displayEmployeeMetrics(a, data) {
            const empData = data.filter(r => r.employee_id);
            if (!empData.length) { document.getElementById('employeeSection').style.display = 'none'; return; }
            
            const byEmp = {};
            empData.forEach(r => {
                const e = r.employee_id;
                if (!byEmp[e]) byEmp[e] = { emissions: 0, distance: 0, cost: 0, trips: 0 };
                byEmp[e].emissions += r.emissions_kg;
                byEmp[e].distance += r.distance_km;
                byEmp[e].cost += r.fuel_cost;
                byEmp[e].trips++;
            });
            
            const emps = Object.keys(byEmp);
            let html = `<div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Employees</div><div class="stat-value">${emps.length}</div></div>
                <div class="stat-card blue"><div class="stat-label">Avg/Employee</div><div class="stat-value">${Math.round(a.totalEmissions / emps.length).toLocaleString()}</div><div class="stat-unit">kg CO2e</div></div>
                <div class="stat-card orange"><div class="stat-label">Avg Cost/Employee</div><div class="stat-value">‚Çπ${Math.round(a.totalFuelCost / emps.length).toLocaleString()}</div></div>
            </div><table><thead><tr><th>Employee ID</th><th>Trips</th><th>Distance</th><th>Emissions</th><th>Cost</th></tr></thead><tbody>`;
            emps.forEach(e => {
                const emp = byEmp[e];
                html += `<tr><td>${e}</td><td>${emp.trips}</td><td>${Math.round(emp.distance).toLocaleString()}</td><td style="font-weight: bold; color: #10b981;">${Math.round(emp.emissions).toLocaleString()}</td><td>‚Çπ${Math.round(emp.cost).toLocaleString()}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('employeeMetrics').innerHTML = html;
        }

        function downloadTemplate() {
            const template = `vehicle_id,vehicle_type,distance_km,fuel_type,location,date,employee_id,employees
CAB001,sedan,1200,diesel,Bangalore,2024-01-15,EMP001,2
CAB002,suv,850,petrol,Mumbai,2024-01-15,EMP002,3
CAB003,hatchback,950,cng,Delhi,2024-01-16,EMP003,1
CAB004,sedan,1100,electric,Pune,2024-01-16,EMP004,2
CAB005,suv,1350,diesel,Bangalore,2024-01-17,EMP005,4
CAB006,hatchback,780,petrol,Mumbai,2024-01-17,EMP006,1
CAB007,sedan,1450,diesel,Bangalore,2024-01-18,EMP007,2
CAB008,suv,920,cng,Delhi,2024-01-18,EMP008,3
CAB009,hatchback,1050,electric,Pune,2024-01-19,EMP009,2
CAB010,sedan,1280,petrol,Bangalore,2024-01-19,EMP010,2`;
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'employee_commute_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function exportToExcel() {
            if (!processedData) { alert('No data to export'); return; }
            const ws = XLSX.utils.json_to_sheet(processedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Emissions Data");
            XLSX.writeFile(wb, `GHG_Emissions_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        async function exportToPDF() {
            if (!analytics) { alert('No data to export'); return; }
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            pdf.setFontSize(20);
            pdf.text('GHG Emissions Report', 105, 15, { align: 'center' });
            pdf.setFontSize(12);
            pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 25, { align: 'center' });
            
            let y = 35;
            pdf.setFontSize(14);
            pdf.text('Executive Summary', 10, y);
            y += 10;
            pdf.setFontSize(10);
            pdf.text(`Total Emissions: ${Math.round(analytics.totalEmissions).toLocaleString()} kg CO2e`, 10, y);
            y += 6;
            pdf.text(`Total Vehicles: ${analytics.totalVehicles}`, 10, y);
            y += 6;
            pdf.text(`Total Distance: ${Math.round(analytics.totalDistance).toLocaleString()} km`, 10, y);
            y += 6;
            pdf.text(`Total Fuel Cost: ‚Çπ${Math.round(analytics.totalFuelCost).toLocaleString()}`, 10, y);
            y += 6;
            pdf.text(`Avg per Vehicle: ${Math.round(analytics.avgEmissions).toLocaleString()} kg CO2e`, 10, y);
            y += 6;
            pdf.text(`Avg per Employee: ${Math.round(analytics.avgPerEmployee).toLocaleString()} kg CO2e`, 10, y);
            
            y += 15;
            pdf.setFontSize(14);
            pdf.text('Fuel Type Breakdown', 10, y);
            y += 10;
            pdf.setFontSize(10);
            Object.keys(analytics.byFuelType).forEach(fuel => {
                const d = analytics.byFuelType[fuel];
                pdf.text(`${fuel.toUpperCase()}: ${Math.round(d.emissions).toLocaleString()} kg CO2e (${d.count} vehicles)`, 10, y);
                y += 6;
            });
            
            if (Object.keys(analytics.byLocation).length > 1) {
                y += 10;
                pdf.setFontSize(14);
                pdf.text('Location Breakdown', 10, y);
                y += 10;
                pdf.setFontSize(10);
                Object.keys(analytics.byLocation).forEach(loc => {
                    const d = analytics.byLocation[loc];
                    pdf.text(`${loc}: ${Math.round(d.emissions).toLocaleString()} kg CO2e (${d.count} vehicles)`, 10, y);
                    y += 6;
                    if (y > 270) { pdf.addPage(); y = 20; }
                });
            }
            
            pdf.save(`GHG_Report_${new Date().toISOString().slice(0,10)}.pdf`);
        }

        function showMessage(text, type) {
            if (!text) { messageDiv.innerHTML = ''; return; }
            messageDiv.className = type;
            messageDiv.textContent = text;
        }
    </script>
</body>
</html>